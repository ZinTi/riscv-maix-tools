# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4

      # 搭建编译环境
      - name: Setup Environment
        shell: bash
        run: |
          ls -a
          cd $GITHUB_WORKSPACE
          chmod +x setup_env.sh
          chmod +x build.sh
          chmod +x package.sh
          source ./setup_env.sh

      # 构建
      - name: Build
        shell: bash
        run: |
          cd $GITHUB_WORKSPACE
          source /etc/profile
          ./build.sh

      # 打包
      - name: Package
        shell: bash
        run: |
          cd $GITHUB_WORKSPACE
          ./package.sh

      # 上传目标文件（比Release页面下载更快）
      - name: Upload to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-pkg
          path: |
            *.tar.xz
            *.tar.gz
            *.7z
            *.zip

      # 发布到Release页面
      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v0.0.1
          body: |
            # riscv-maix-tools Release Notes
            
            ## Build Information
            - **Version**: v0.0.1

          files: |
            *.tar.xz
            *.tar.gz
            *.7z
            *.zip
          overwrite_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

